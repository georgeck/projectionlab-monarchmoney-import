<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Monarch ProjectionLab Connector</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <style>
        .form-control {
            max-width: 500px;
        }

        .step {
            display: none;
        }

        .active-step {
            display: block;
        }

        .step-indicator {
            margin-bottom: 30px;
        }

        .step-indicator .step-circle {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e9ecef;
            text-align: center;
            line-height: 30px;
            margin-right: 5px;
        }

        .step-indicator .active {
            background-color: #0d6efd;
            color: white;
        }

        .step-indicator .completed {
            background-color: #198754;
            color: white;
        }

        .snippet-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            font-family: monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .form-select {
            max-width: 400px;
        }
    </style>
</head>

<body class="container">

<div class="p-5 mb-1 bg-body-tertiary rounded-3">
    <div class="container-fluid py-2">
        <h1 class="display-5">Monarch to ProjectionLab Connector</h1>
    </div>
</div>

<div class="step-indicator text-center">
    <div class="step-circle" id="step-1-indicator">1</div>
    <div class="step-circle" id="step-2-indicator">2</div>
    <div class="step-circle" id="step-3-indicator">3</div>
</div>

<!-- Step 1: ProjectionLab Setup -->
<div id="step-1" class="step active-step">
    <h3>Step 1: ProjectionLab Setup</h3>
    <p>Enter your ProjectionLab API Key, then run the generated snippet in your
        <a href="https://app.projectionlab.com" target="_blank">ProjectionLab</a> browser console to export your accounts.</p>

    <div class="mb-3">
        <label for="projectionLabsApiKey" class="form-label">ProjectionLab API Key</label>
        <input type="text" class="form-control" id="projectionLabsApiKey"
               placeholder="Enter your API key" oninput="updateSnippet()">
        <div class="form-text">Account Settings &gt; Plugins &gt; Plugin API Key</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Browser Console Snippet</label>
        <p class="text-muted small">Copy this snippet, open ProjectionLab in your browser, open the
            developer console (F12), paste it and press Enter. Your accounts will be copied to your clipboard.</p>
        <div class="snippet-box" id="plSnippet"></div>
        <button class="btn btn-sm btn-outline-secondary mt-2" onclick="copySnippet()">Copy Snippet</button>
    </div>

    <div class="mb-3">
        <label for="plAccountsJson" class="form-label">Paste Account Data</label>
        <textarea class="form-control" id="plAccountsJson" rows="5"
                  placeholder="Paste the JSON from your clipboard here..."></textarea>
        <button class="btn btn-sm btn-primary mt-2" onclick="loadPlAccounts()">Load Accounts</button>
    </div>

    <div id="plAccountsResult" class="mt-2"></div>

    <div class="mt-4">
        <button class="btn btn-primary" id="step1NextBtn" onclick="nextStep(1)" disabled>Next</button>
    </div>
</div>

<!-- Step 2: Monarch Setup -->
<div id="step-2" class="step">
    <h3>Step 2: Monarch Credentials</h3>
    <p>Enter your Monarch Money credentials to fetch your accounts.</p>

    <div class="mb-3">
        <label for="monarchEmail" class="form-label">Email</label>
        <input type="email" class="form-control" id="monarchEmail" placeholder="Monarch email">
    </div>
    <div class="mb-3">
        <label for="monarchPassword" class="form-label">Password</label>
        <input type="password" class="form-control" id="monarchPassword" placeholder="Monarch password">
    </div>
    <div class="mb-3">
        <label for="monarchMfa" class="form-label">MFA Secret (optional)</label>
        <input type="text" class="form-control" id="monarchMfa"
               placeholder="TOTP secret (the 30+ character code, not the 6-digit code)">
    </div>
    <div class="mb-3">
        <label for="deviceUuid" class="form-label">Device UUID</label>
        <input type="text" class="form-control" id="deviceUuid" placeholder="Device UUID">
        <button class="btn btn-sm btn-outline-secondary mt-2" onclick="generateUUID()">Generate UUID</button>
    </div>

    <div class="mt-4">
        <button class="btn btn-secondary" onclick="prevStep(2)">Back</button>
        <button class="btn btn-primary" id="fetchMonarchBtn" onclick="fetchMonarchAccounts()">Fetch Monarch Accounts</button>
    </div>

    <div id="monarchAccountsList" class="mt-3"></div>

    <div class="mt-4">
        <button class="btn btn-primary" id="step2NextBtn" onclick="nextStep(2)" disabled>Next</button>
    </div>
</div>

<!-- Step 3: Account Mapping -->
<div id="step-3" class="step">
    <h3>Step 3: Account Mapping</h3>
    <p>Map each Monarch account to the corresponding ProjectionLab account. Select &ldquo;— Skip —&rdquo; for accounts you don&rsquo;t want to sync.</p>

    <div id="mappingSection" class="mb-3">
        <table class="table">
            <thead>
            <tr>
                <th>Monarch Account</th>
                <th>ProjectionLab Account</th>
            </tr>
            </thead>
            <tbody id="mappingBody"></tbody>
        </table>
    </div>

    <div class="mt-4">
        <button class="btn btn-secondary" onclick="prevStep(3)">Back</button>
        <button class="btn btn-success" onclick="saveConfiguration()">Save Configuration</button>
    </div>

    <div id="saveResult" class="mt-3"></div>
</div>

<script>
    // --------------- Global state ---------------
    let plAccounts = [];
    let monarchAccounts = [];
    let existingMapping = [];

    // --------------- Init ---------------
    window.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('step-1-indicator').classList.add('active');
        updateSnippet();
        await loadExistingConfig();
    });

    async function loadExistingConfig() {
        try {
            const response = await fetch('/api/get-config');
            if (!response.ok) return;
            const config = await response.json();

            document.getElementById('projectionLabsApiKey').value = config.projection_Labs_api_key || '';
            document.getElementById('monarchEmail').value = config.monarchCredentials?.monarch_email || '';
            document.getElementById('monarchPassword').value = config.monarchCredentials?.monarch_password || '';
            document.getElementById('monarchMfa').value = config.monarchCredentials?.monarch_mfa || '';
            document.getElementById('deviceUuid').value = config.monarchCredentials?.device_uuid || '';

            if (config.accountMapping && config.accountMapping.length > 0) {
                existingMapping = config.accountMapping;
            }

            updateSnippet();
        } catch (error) {
            console.error('Failed to load config:', error);
        }
    }

    // --------------- Step 1: ProjectionLab Setup ---------------
    function updateSnippet() {
        const apiKey = document.getElementById('projectionLabsApiKey').value || 'YOUR_API_KEY';
        document.getElementById('plSnippet').textContent =
`(async () => {
  const e = await window.projectionlabPluginAPI.exportData({ key: '${apiKey}' });
  const a = [...e.today.savingsAccounts, ...e.today.investmentAccounts,
             ...e.today.assets, ...e.today.debts];
  const r = a.map(x => ({ id: x.id, name: x.name }));
  copy(JSON.stringify(r));
  console.log('Copied ' + r.length + ' accounts to clipboard!');
})();`;
    }

    function copySnippet() {
        const text = document.getElementById('plSnippet').textContent;
        navigator.clipboard.writeText(text).then(() => {
            const btn = document.querySelector('[onclick="copySnippet()"]');
            const orig = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = orig, 1500);
        });
    }

    function loadPlAccounts() {
        const json = document.getElementById('plAccountsJson').value.trim();
        const resultDiv = document.getElementById('plAccountsResult');

        if (!json) {
            resultDiv.innerHTML = '<div class="alert alert-warning">Please paste the JSON data first.</div>';
            return;
        }

        try {
            const accounts = JSON.parse(json);

            if (!Array.isArray(accounts) || accounts.length === 0) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Invalid data: expected a non-empty array of accounts.</div>';
                return;
            }
            if (!accounts[0].id || !accounts[0].name) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Invalid data: each account must have "id" and "name" fields.</div>';
                return;
            }

            plAccounts = accounts;
            resultDiv.innerHTML = `<div class="alert alert-success">Loaded ${accounts.length} ProjectionLab accounts.</div>`;
            document.getElementById('step1NextBtn').disabled = false;
        } catch (e) {
            resultDiv.innerHTML = `<div class="alert alert-danger">Invalid JSON: ${e.message}</div>`;
        }
    }

    // --------------- Step 2: Monarch Setup ---------------
    function generateUUID() {
        document.getElementById('deviceUuid').value = crypto.randomUUID();
    }

    async function fetchMonarchAccounts() {
        const email = document.getElementById('monarchEmail').value;
        const password = document.getElementById('monarchPassword').value;
        const mfa = document.getElementById('monarchMfa').value;
        const deviceUuid = document.getElementById('deviceUuid').value;

        if (!email || !password || !deviceUuid) {
            alert('Please fill in email, password, and device UUID.');
            return;
        }

        const listDiv = document.getElementById('monarchAccountsList');
        const fetchBtn = document.getElementById('fetchMonarchBtn');
        listDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
        fetchBtn.disabled = true;

        try {
            const response = await fetch('/api/get-monarch-accounts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    monarchCredentials: {
                        monarch_email: email,
                        monarch_password: password,
                        monarch_mfa: mfa,
                        device_uuid: deviceUuid
                    }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                listDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.errorDetail || 'Failed to fetch accounts'}</div>`;
                return;
            }

            const accounts = await response.json();
            monarchAccounts = accounts;

            let html = `<div class="alert alert-success">Found ${accounts.length} Monarch accounts.</div>`;
            html += '<table class="table table-sm"><thead><tr><th>ID</th><th>Name</th></tr></thead><tbody>';
            accounts.forEach(a => {
                html += `<tr><td><code>${a.id}</code></td><td>${a.displayName}</td></tr>`;
            });
            html += '</tbody></table>';
            listDiv.innerHTML = html;

            document.getElementById('step2NextBtn').disabled = false;
        } catch (error) {
            listDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        } finally {
            fetchBtn.disabled = false;
        }
    }

    // --------------- Step 3: Account Mapping ---------------
    function renderMappingTable() {
        const tbody = document.getElementById('mappingBody');
        tbody.innerHTML = '';

        monarchAccounts.forEach(mAccount => {
            const row = document.createElement('tr');

            const nameCell = document.createElement('td');
            nameCell.textContent = mAccount.displayName;
            row.appendChild(nameCell);

            const selectCell = document.createElement('td');
            const select = document.createElement('select');
            select.className = 'form-select';
            select.dataset.monarchId = mAccount.id;
            select.dataset.monarchName = mAccount.displayName;

            // Skip option
            const skipOpt = document.createElement('option');
            skipOpt.value = '';
            skipOpt.textContent = '— Skip —';
            select.appendChild(skipOpt);

            // PL account options
            plAccounts.forEach(plAccount => {
                const opt = document.createElement('option');
                opt.value = plAccount.id;
                opt.textContent = plAccount.name;

                // Pre-select from existing mapping
                const existing = existingMapping.find(m => m.monarchAccountID === mAccount.id);
                if (existing && existing.plAccountID === plAccount.id) {
                    opt.selected = true;
                }

                select.appendChild(opt);
            });

            selectCell.appendChild(select);
            row.appendChild(selectCell);
            tbody.appendChild(row);
        });
    }

    async function saveConfiguration() {
        const selects = document.querySelectorAll('#mappingBody select');
        const accountMapping = [];

        selects.forEach(select => {
            if (select.value) {
                const plAccount = plAccounts.find(a => a.id === select.value);
                accountMapping.push({
                    plAccountID: select.value,
                    monarchAccountID: select.dataset.monarchId,
                    plDisplayName: plAccount ? plAccount.name : ''
                });
            }
        });

        if (accountMapping.length === 0) {
            document.getElementById('saveResult').innerHTML =
                '<div class="alert alert-warning">Please map at least one account.</div>';
            return;
        }

        const configData = {
            projection_Labs_api_key: document.getElementById('projectionLabsApiKey').value,
            monarchCredentials: {
                monarch_email: document.getElementById('monarchEmail').value,
                monarch_password: document.getElementById('monarchPassword').value,
                monarch_mfa: document.getElementById('monarchMfa').value,
                device_uuid: document.getElementById('deviceUuid').value
            },
            accountMapping
        };

        try {
            const response = await fetch('/api/save-complete-config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(configData)
            });

            if (response.ok) {
                existingMapping = accountMapping;
                document.getElementById('saveResult').innerHTML = `
                    <div class="alert alert-success">
                        <p><strong>Configuration saved!</strong></p>
                        <p>Mapped ${accountMapping.length} accounts.</p>
                        <p>To sync balances, run: <code>node index.js</code></p>
                        <p>Then paste the output into ProjectionLab's browser console.</p>
                    </div>`;
            } else {
                const error = await response.json();
                document.getElementById('saveResult').innerHTML =
                    `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        } catch (error) {
            document.getElementById('saveResult').innerHTML =
                `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    }

    // --------------- Navigation ---------------
    function nextStep(current) {
        if (current === 1) {
            const apiKey = document.getElementById('projectionLabsApiKey').value;
            if (!apiKey || plAccounts.length === 0) {
                alert('Please enter your API key and load your ProjectionLab accounts first.');
                return;
            }
        }
        if (current === 2 && monarchAccounts.length === 0) {
            alert('Please fetch your Monarch accounts first.');
            return;
        }

        document.getElementById(`step-${current}`).classList.remove('active-step');
        document.getElementById(`step-${current + 1}`).classList.add('active-step');
        document.getElementById(`step-${current}-indicator`).classList.remove('active');
        document.getElementById(`step-${current}-indicator`).classList.add('completed');
        document.getElementById(`step-${current + 1}-indicator`).classList.add('active');

        // Render mapping table when entering step 3
        if (current + 1 === 3) {
            renderMappingTable();
        }
    }

    function prevStep(current) {
        document.getElementById(`step-${current}`).classList.remove('active-step');
        document.getElementById(`step-${current - 1}`).classList.add('active-step');
        document.getElementById(`step-${current}-indicator`).classList.remove('active');
        document.getElementById(`step-${current - 1}-indicator`).classList.remove('completed');
        document.getElementById(`step-${current - 1}-indicator`).classList.add('active');
    }
</script>
<script src="/javascripts/bootstrap.bundle.min.js"></script>
</body>
</html>
