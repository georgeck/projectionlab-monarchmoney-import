<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Monarch ProjectionLab Connector</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <style>
        .form-control {
            max-width: 500px;
        }

        .step {
            display: none;
        }

        .active-step {
            display: block;
        }

        .step-indicator {
            margin-bottom: 30px;
        }

        .step-indicator .step-circle {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e9ecef;
            text-align: center;
            line-height: 30px;
            margin-right: 5px;
        }

        .step-indicator .active {
            background-color: #0d6efd;
            color: white;
        }

        .step-indicator .completed {
            background-color: #198754;
            color: white;
        }
    </style>
</head>

<body class="container">

<div class="p-5 mb-1 bg-body-tertiary rounded-3">
    <div class="container-fluid py-2">
        <h1 class="display-5">Monarch to ProjectionLab Connector</h1>
    </div>
</div>

<div class="step-indicator text-center">
    <div class="step-circle" id="step-1-indicator">1</div>
    <div class="step-circle" id="step-2-indicator">2</div>
    <div class="step-circle" id="step-3-indicator">3</div>
</div>

<!-- Step 1: ProjectionLab API Key -->
<div id="step-1" class="step active-step">
    <h3>Step 1: ProjectionLab Setup</h3>
    <p>Enter your ProjectionLab API Key. You can find this in ProjectionLab under Account Settings > Plugins.</p>

    <div class="mb-3">
        <label for="projectionLabsApiKey" class="form-label">ProjectionLabs API Key</label>
        <input type="text" class="form-control" id="projectionLabsApiKey" placeholder="ProjectionLabs API Key">
    </div>

    <div class="mt-4">
        <button class="btn btn-primary" onclick="nextStep(1)">Next</button>
    </div>
</div>

<!-- Step 2: ProjectionLab Account Mapping -->
<div id="step-2" class="step">
    <h3>Step 2: Monarch Credentials</h3>
    <p>Enter your Monarch Money credentials to connect to your accounts.</p>

    <div class="mb-3">
        <label for="monarchEmail" class="form-label">Monarch Email</label>
        <input type="email" class="form-control" id="monarchEmail" placeholder="Monarch Email">
    </div>
    <div class="mb-3">
        <label for="monarchPassword" class="form-label">Monarch Password</label>
        <input type="password" class="form-control" id="monarchPassword" placeholder="Monarch Password">
    </div>
    <div class="mb-3">
        <label for="monarchMfa" class="form-label">Monarch MFA Code (optional)</label>
        <input type="text" class="form-control" id="monarchMfa" placeholder="MFA Secret">
    </div>
    <div class="mb-3">
        <label for="deviceUuid" class="form-label">Device UUID</label>
        <input type="text" class="form-control" id="deviceUuid" placeholder="Device UUID">
        <button class="btn btn-sm btn-secondary mt-2" onclick="generateUUID()">Generate UUID</button>
    </div>

    <div class="mt-4">
        <button class="btn btn-secondary" onclick="prevStep(1)">Back</button>
        <button class="btn btn-primary" onclick="fetchMonarchAccounts()">Get Monarch Accounts</button>
    </div>

    <div id="monarchAccountsList" class="mt-3">
        <!-- Monarch accounts will be displayed here -->
    </div>

    <div class="mt-4" id="finalizeSection" style="display: none;">
        <h4>Final Step: Create Configuration</h4>
        <button class="btn btn-success" onclick="createConfiguration()">Create Configuration</button>
        <div id="configResult" class="mt-2"></div>
    </div>
</div>

<!-- Step 3: Monarch Credentials -->
<div id="step-3" class="step">
    <h3>Step 3: ProjectionLab Account Mapping</h3>
    <p>Here are your ProjectionLab accounts. Map which ones you want to update with Monarch data.</p>

    <div id="accountMappingSection" class="mb-3">
        <table class="table" id="accountMappingTable">
            <thead>
            <tr>
                <th>Account ID</th>
                <th>Account Name</th>
                <th>Include</th>
            </tr>
            </thead>
            <tbody id="accountMappingBody">
            <!-- Account mapping rows will be added here -->
            </tbody>
        </table>
    </div>

    <div class="mt-4">
        <button class="btn btn-secondary" onclick="prevStep(2)">Back</button>
        <button class="btn btn-primary" onclick="nextStep(2)">Next</button>
    </div>
</div>

<script>
    // Global variables to store data
    let selectedAccounts = [];
    let monarchAccounts = [];

    // Navigation functions
    function nextStep(currentStep) {
        document.getElementById(`step-${currentStep}`).classList.remove('active-step');
        document.getElementById(`step-${currentStep + 1}`).classList.add('active-step');

        document.getElementById(`step-${currentStep}-indicator`).classList.add('completed');
        document.getElementById(`step-${currentStep + 1}-indicator`).classList.add('active');
    }

    function prevStep(currentStep) {
        document.getElementById(`step-${currentStep}`).classList.remove('active-step');
        document.getElementById(`step-${currentStep - 1}`).classList.add('active-step');

        document.getElementById(`step-${currentStep}-indicator`).classList.remove('active');
        document.getElementById(`step-${currentStep - 1}-indicator`).classList.add('active');
    }

    // Initialize step indicators
    window.addEventListener('DOMContentLoaded', () => {
        document.getElementById('step-1-indicator').classList.add('active');

        // Try to load existing config
        loadExistingConfig();
    });

    async function loadExistingConfig() {
        try {
            const config = await fetchConfig();
            document.getElementById('projectionLabsApiKey').value = config.projection_Labs_api_key || '';
            document.getElementById('monarchEmail').value = config.monarchCredentials.monarch_email || '';
            document.getElementById('monarchPassword').value = config.monarchCredentials.monarch_password || '';
            document.getElementById('monarchMfa').value = config.monarchCredentials.monarch_mfa || '';
            document.getElementById('deviceUuid').value = config.monarchCredentials.device_uuid || '';
        } catch (error) {
            console.error('Failed to load config:', error);
        }
    }

    async function fetchConfig() {
        const response = await fetch('/api/get-config');
        if (response.ok) {
            return await response.json();
        } else {
            throw new Error(`Failed to fetch config: ${response.status} ${response.statusText}`);
        }
    }


    async function fetchMonarchAccounts() {
        const monarchEmail = document.getElementById('monarchEmail').value;
        const monarchPassword = document.getElementById('monarchPassword').value;
        const monarchMfa = document.getElementById('monarchMfa').value;
        const deviceUuid = document.getElementById('deviceUuid').value;

        if (!monarchEmail || !monarchPassword || !deviceUuid) {
            alert('Please fill in all required Monarch credentials');
            return;
        }

        const monarchAccountsList = document.getElementById('monarchAccountsList');
        monarchAccountsList.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';

        try {
            const response = await fetch('/api/get-monarch-accounts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    monarchCredentials: {
                        monarch_email: monarchEmail,
                        monarch_password: monarchPassword,
                        monarch_mfa: monarchMfa,
                        device_uuid: deviceUuid
                    }
                })
            });

            if (response.ok) {
                const accounts = await response.json();
                monarchAccounts = accounts;
                displayMonarchAccounts(accounts);
                document.getElementById('finalizeSection').style.display = 'block';
            } else {
                const error = await response.json();
                monarchAccountsList.innerHTML = `<div class="alert alert-danger">Error: ${error.errorDetail || 'Failed to fetch accounts'}</div>`;
            }
        } catch (error) {
            monarchAccountsList.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    }

    function displayMonarchAccounts(accounts) {
        const monarchAccountsList = document.getElementById('monarchAccountsList');

        if (accounts.length === 0) {
            monarchAccountsList.innerHTML = '<div class="alert alert-warning">No accounts found</div>';
            return;
        }

        let html = `
            <div class="alert alert-success">Found ${accounts.length} accounts</div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Account ID</th>
                        <th>Account Name</th>
                    </tr>
                </thead>
                <tbody>
        `;

        accounts.forEach(account => {
            html += `
                <tr>
                    <td>${account.id}</td>
                    <td>${account.displayName}</td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        monarchAccountsList.innerHTML = html;
    }

    async function createConfiguration() {
        // Get selected accounts from step 2
        const checkboxes = document.querySelectorAll('.account-checkbox:checked');
        selectedAccounts = Array.from(checkboxes).map(checkbox => ({
            id: checkbox.getAttribute('data-id'),
            name: checkbox.getAttribute('data-name')
        }));

        if (selectedAccounts.length === 0) {
            alert('Please select at least one account to map');
            return;
        }

        if (monarchAccounts.length === 0) {
            alert('Please fetch Monarch accounts first');
            return;
        }

        // Create account mapping
        const accountMapping = [];
        selectedAccounts.forEach(plAccount => {
            // Find a matching Monarch account by name (simplified matching)
            const matchingMonarchAccount = findMatchingMonarchAccount(plAccount.name);
            if (matchingMonarchAccount) {
                accountMapping.push({
                    plAccountID: plAccount.id,
                    monarchAccountID: matchingMonarchAccount.id,
                    plDisplayName: plAccount.name
                });
            }
        });

        // Create configuration object
        const configData = {
            projection_Labs_api_key: document.getElementById('projectionLabsApiKey').value,
            monarchCredentials: {
                monarch_email: document.getElementById('monarchEmail').value,
                monarch_password: document.getElementById('monarchPassword').value,
                monarch_mfa: document.getElementById('monarchMfa').value,
                device_uuid: document.getElementById('deviceUuid').value
            },
            accountMapping
        };

        try {
            const response = await fetch('/api/save-complete-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(configData)
            });

            if (response.ok) {
                const result = await response.json();
                document.getElementById('configResult').innerHTML = `
                    <div class="alert alert-success">
                        <p>Configuration saved successfully!</p>
                        <p>Created mapping for ${accountMapping.length} accounts.</p>
                        <p>To update your ProjectionLab accounts, run: <code>node index.js</code></p>
                    </div>
                `;
            } else {
                const error = await response.json();
                document.getElementById('configResult').innerHTML = `
                    <div class="alert alert-danger">Error: ${error.message}</div>
                `;
            }
        } catch (error) {
            document.getElementById('configResult').innerHTML = `
                <div class="alert alert-danger">Error: ${error.message}</div>
            `;
        }
    }

    function findMatchingMonarchAccount(plAccountName) {
        // This is a simple matching function - you might need to make it more sophisticated
        const normalizedPlName = plAccountName.toLowerCase().replace(/\s+/g, '');

        return monarchAccounts.find(monarchAccount => {
            const normalizedMonarchName = monarchAccount.displayName.toLowerCase().replace(/\s+/g, '');
            return normalizedMonarchName.includes(normalizedPlName) ||
                normalizedPlName.includes(normalizedMonarchName);
        });
    }
</script>
<script src="/javascripts/bootstrap.bundle.min.js"></script>
</body>
</html>